<!DOCTYPE html>
<html lang="ko"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/park.html}">
>
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        #mapwrap{position:relative;overflow:hidden;}
        .category, .category *{margin:0;padding:0;color:#000;}
        .category {
            overflow:hidden;
            position:absolute;top:10px;left:10px;width:200px;height:60px;z-index:10;border:1px solid black;font-family:'Malgun Gothic','맑은 고딕',sans-serif;font-size:12px;text-align:center;background-color:#fff;}
        .category .menu_selected {background:#FF5F4A;color:#fff;border-left:1px solid #915B2F;border-right:1px solid #915B2F;margin:0 -1px;}
        .category li{list-style:none;float:left;width:50px;height:45px;padding-top:5px;cursor:pointer;}
        .category .ico_comm {display:block;margin:0 auto 2px;width:22px;height:26px;background:url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/category.png') no-repeat;}
        .category .ico_coffee {background-position:-10px 0;}
        .category .ico_store {background-position:-10px -36px;}
        .category .ico_carpark {background-position:-10px -72px;}
    </style>
</head>
<body>
<div layout:fragment="content">
    <div id="mapwrap">
        <div id="map" style="width:1024px;height:1024px;"></div>
        <div class="category">
            <ul>
                <li id="allMenu" onclick="changeMarker('all')">
                    <span class="ico_comm ico_coffee"></span>
                    전체
                </li>
                <li id="attractionMenu" onclick="changeMarker('attraction')">
                    <span class="ico_comm ico_coffee"></span>
                    어트랙션
                </li>
                <li id="shopMenu" onclick="changeMarker('shop')">
                    <span class="ico_comm ico_store"></span>
                    매장
                </li>
                <li id="conMenu" onclick="changeMarker('con')">
                    <span class="ico_comm ico_carpark"></span>
                    편의시설
                </li>
            </ul>
        </div>
    </div>
    <p id="result"></p>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6e208eb09fba9417845ed12cf12f3aef"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/map.js"></script>
</div>
<script layout:fragment="script" th:inline="javascript">

    // 맵 등록
    const domain = 'https://img.freepik.com';
    const path = '/premium-photo/children-s-amusement-park-and-water-games_918459-6424.jpg?w=1060&';
    const plan = function( x, y, z ) {
        y = -y - 1;
        const limit = Math.ceil( 3 / Math.pow( 2, z ) );

        if ( 0 <= y && y < limit && 0 <= x && x < limit ) {
            return domain + path + 'planh' +
                z + '_' + y + '_' + x + '.png';
        } else {
            return 'https://i1.daumcdn.net/dmaps/apis/white.png';
        }
    };

    kakao.maps.Tileset.add( 'PLAN',
        new kakao.maps.Tileset(
            1024, 1024, plan, '', false, 0, 2 ) );

    const node = document.getElementById( 'map' );
    const map = new kakao.maps.Map( node, {
        projectionId: null,
        mapTypeId: kakao.maps.MapTypeId.PLAN,
        $scale: false,
        // center: new kakao.maps.LatLng(37.498004414546934, 127.02770621963765)
        center: new kakao.maps.Coords( 2048, -2048 ),
        draggable: false,
        level: 4
    });
    const center = map.getCenter();


    const markerList = [];
    let currentInfoWindow = null; // 현재 열려있는 윈도우인포
    // 시설 마커 위치 배열
    const attractionPositions = [];
    const shopPositions = [];
    const conPositions = [];

    setMarkers();
    // 마커 리스트
    console.log(markerList);
    console.log(attractionPositions);
    console.log(shopPositions);
    console.log(conPositions);

    function setMarkers(){
        getMarkers().then(markers => {
            console.log('Markers:', markers);
            // 배열에 결과를 추가합니다.
            markerList.push(...markers);
            setMarkerPositions(markerList);
            createAttractionMarkers();
            createShopMarkers();
            createConMarkers();
        });
    }
    function setMarkerPositions(markers){
        markers.forEach(function (markerDTO){
            if(markerDTO.type === "어트랙션"){
                attractionPositions.push({
                    position: new kakao.maps.LatLng(markerDTO.latitude, markerDTO.longitude),
                    facilityNo: markerDTO.facility_no,
                    type: markerDTO.type});
            }
            else if(markerDTO.type === "매장"){
                shopPositions.push({
                    position: new kakao.maps.LatLng(markerDTO.latitude, markerDTO.longitude),
                    facilityNo: markerDTO.facility_no,
                    type: markerDTO.type});
            }
            else{
                conPositions.push({
                    position: new kakao.maps.LatLng(markerDTO.latitude, markerDTO.longitude),
                    facilityNo: markerDTO.facility_no,
                    type: markerDTO.type});
            }
        })
    }

    // 시설 마커 배열
    const attractionMarkers = [];
    const shopMarkers = [];
    const conMarkers = [];

    var markerImageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/category.png';  // 마커이미지의 주소입니다. 스프라이트 이미지 입니다

    // 마커이미지의 주소와, 크기, 옵션으로 마커 이미지를 생성하여 리턴하는 함수입니다
    function createMarkerImage(src, size, options) {
        let markerImage = new kakao.maps.MarkerImage(src, size, options);
        return markerImage;
    }

    // 좌표와 마커이미지를 받아 마커를 생성하여 리턴하는 함수입니다 < 이벤트 생성 시점
    function createMarker(position, image) {
        let marker = new kakao.maps.Marker({
            position: position.position,
            image: image,
            clickable: true
        });
        marker.facilityNo = position.facilityNo;
        marker.type = position.type;

        kakao.maps.event.addListener(marker, 'click', function (){
            openInfoWindow(marker);
        });
        return marker;
    }
    async function openInfoWindow(marker) {
        //현재 열려있는 infowindow 끄기
        if (currentInfoWindow) {
            currentInfoWindow.close();
        }
        // 마커 정보를 가져오기
        const markerInfo = await getMarkerOne(marker.type, marker.facilityNo);

        // 가져온 정보를 이용하여 content 작성
        let content = getContentByType(markerInfo,marker.type);

        // InfoWindow 생성
        let infoWindow = new kakao.maps.InfoWindow({
            content: content,
            position: marker.getPosition(),
            removable: true
        });

        // 지도에 InfoWindow 표시
        infoWindow.open(map, marker);
        currentInfoWindow = infoWindow;
    }
    // 타입에 따라 다른 content를 반환하는 함수
    function getContentByType(markerInfo,type) {
        if (markerInfo) {
            switch (type){
                case "어트랙션":
                    return markerInfo.aname;
                case "매장":
                    return markerInfo.shop_name;
                case "편의시설":
                default:
                    return markerInfo.name;
            }
        } else {
            return '<div>해당 정보를 가져올 수 없습니다.</div>';
        }
    }

    function createAttractionMarkers(){
        for(let i = 0; i < attractionPositions.length; i++){

            let imageSize = new kakao.maps.Size(22, 26),
                imageOptions = {
                    spriteOrigin: new kakao.maps.Point(10, 0),
                    spriteSize: new kakao.maps.Size(36, 98)
                };
            let markerImage = createMarkerImage(markerImageSrc, imageSize, imageOptions)
            let marker = createMarker(attractionPositions[i], markerImage);

            attractionMarkers.push(marker);
        }
    }

    function createShopMarkers(){
        for(let i = 0; i < shopPositions.length; i++){

            let imageSize = new kakao.maps.Size(22, 26),
                imageOptions = {
                    spriteOrigin: new kakao.maps.Point(8, 0),
                    spriteSize: new kakao.maps.Size(36, 98)
                };
            let markerImage = createMarkerImage(markerImageSrc, imageSize, imageOptions)
            let marker = createMarker(shopPositions[i], markerImage);

            shopMarkers.push(marker);
        }
    }

    function createConMarkers(){
        for(let i = 0; i < conPositions.length; i++){

            let imageSize = new kakao.maps.Size(22, 26),
                imageOptions = {
                    spriteOrigin: new kakao.maps.Point(7, 0),
                    spriteSize: new kakao.maps.Size(36, 98)
                };
            let markerImage = createMarkerImage(markerImageSrc, imageSize, imageOptions)
            let marker = createMarker(conPositions[i], markerImage);

            conMarkers.push(marker);
        }
    }

    function setAttractionMarkers(map) {
        for (let i = 0; i < attractionMarkers.length; i++) {
            attractionMarkers[i].setMap(map);
        }
    }

    function setShopMarkers(map) {
        for (let i = 0; i < shopMarkers.length; i++) {
            shopMarkers[i].setMap(map);
        }
    }

    function setConMarkers(map) {
        for (let i = 0; i < conMarkers.length; i++) {
            conMarkers[i].setMap(map);
        }
    }

    changeMarker('all'); // 지도에 전체 마커가 보이도록 설정합니다

    // 카테고리를 클릭했을 때 type에 따라 카테고리의 스타일과 지도에 표시되는 마커를 변경합니다
    function changeMarker(type){

        const attractionMenu = document.getElementById('attractionMenu');
        const shopMenu = document.getElementById('shopMenu');
        const conMenu = document.getElementById('conMenu');
        const allMenu = document.getElementById('allMenu');

        // 커피숍 카테고리가 클릭됐을 때
        if (type === 'attraction') {

            // 커피숍 카테고리를 선택된 스타일로 변경하고
            attractionMenu.className = 'menu_selected';

            // 편의점과 주차장 카테고리는 선택되지 않은 스타일로 바꿉니다
            shopMenu.className = '';
            conMenu.className = '';
            allMenu.className = '';

            // 커피숍 마커들만 지도에 표시하도록 설정합니다
            setAttractionMarkers(map);
            setShopMarkers(null);
            setConMarkers(null);

        } else if (type === 'shop') { // 편의점 카테고리가 클릭됐을 때

            // 편의점 카테고리를 선택된 스타일로 변경하고
            attractionMenu.className = '';
            shopMenu.className = 'menu_selected';
            conMenu.className = '';
            allMenu.className = '';

            // 편의점 마커들만 지도에 표시하도록 설정합니다
            setAttractionMarkers(null);
            setShopMarkers(map);
            setConMarkers(null);

        } else if (type === 'con') { // 주차장 카테고리가 클릭됐을 때

            // 주차장 카테고리를 선택된 스타일로 변경하고
            attractionMenu.className = '';
            shopMenu.className = '';
            conMenu.className = 'menu_selected';
            allMenu.className = '';

            // 주차장 마커들만 지도에 표시하도록 설정합니다
            setAttractionMarkers(null);
            setShopMarkers(null);
            setConMarkers(map);
        } else if(type === 'all'){
            attractionMenu.className = '';
            shopMenu.className = '';
            conMenu.className = '';
            allMenu.className = 'menu_selected';
            setAttractionMarkers(map);
            setShopMarkers(map);
            setConMarkers(map);
        }
    }

    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {

        // 클릭한 위도, 경도 정보를 가져옵니다
        const latlng = mouseEvent.latLng;

        let message = '클릭한 위치의 위도는 ' + latlng.getLat() + ' 이고, ';
        message += '경도는 ' + latlng.getLng() + ' 입니다';

        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = message;

        // 클릭한 위치의 마커 객체를 가져옵니다
        let target = mouseEvent.target;

        // 마커를 클릭한 경우에만 실행
        if (target instanceof kakao.maps.Marker) {
            // 마커의 custom 속성에서 시설번호와 타입을 가져옵니다
            let facilityNo = target.facilityNo;
            let type = target.type;

            // 가져온 정보를 이용하여 상세 정보를 요청하거나 출력합니다
            console.log('Facility No:', facilityNo);
            console.log('Type:', type);
        }

    });

    getMarkerOne('어트랙션',5);
</script>
</body>
</html>