<!DOCTYPE html>
<html lang="ko"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/park.html}">

<head>
    <meta charset="UTF-8">
    <title>정보수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
</head>
<body>
<div layout:fragment="content">
    <!-- Contact section-->
    <section class="bg-light py-5">
        <div class="container px-5 my-5 px-5">
            <div class="text-center mb-5">
                <h2 class="fw-bolder">정보수정</h2>
                <p class="lead mb-0">수정할 정보를 입력해 주세요.</p>
            </div>
            <div class="row gx-5 justify-content-center">
                <div class="col-lg-6">
                    <form name="registerForm" action="/member/edit" method="post">
                        <p class="lead mb-0">필수 입력 정보</p>
                        <hr>
                        <!-- 이메일주소 input-->
                        <div class="form-floating mb-3">
                            <input class="form-control" id="email_id" name="email_id" type="email" th:value="${memberDTO.email_id}" readonly/>
                            <label for="email_id">이메일 ID</label>
                        </div>

                        <!-- 비밀번호 input-->
                        <div class="form-floating mb-3">
                            <input class="form-control" id="Epassword" name="Epassword" type="password"
                                   placeholder="비밀번호를 입력하세요..."/>
                            <label for="password">기존 비밀번호 확인</label>
                            <span class="form-check" id="Epass-span" name="Epass-span" style="display: none"/>
                        </div>

                        <a href="#" id="pwCheck">비밀번호 변경</a>
                        <!-- 비밀번호 input-->
                        <div class="form-floating mb-3" name="pwCk" style="display: none">
                            <input class="form-control" id="password" name="password" type="password"
                                   placeholder="비밀번호를 입력하세요..."/>
                            <label for="password">변경할 비밀번호</label>
                            <span class="form-check" id="password-span" name="password-span" style="display: none"/>
                        </div>

                        <!-- 비밀번호 확인 input-->
                        <div class="form-floating mb-3" name="pwCk2" style="display: none">
                            <input class="form-control" id="passwordConfirm" name="passwordConfirm" type="password"
                                   placeholder="비밀번호 확인을 입력하세요..."/>
                            <label for="passwordConfirm">변경할 비밀번호 확인</label>
                            <span class="form-check" id="passwordRE-span" name="passwordRE-span" style="display: none"/>
                        </div>

                        <!-- 닉네임 input-->
                        <div class="form-floating mb-3">
                            <input class="form-control" id="nickName" name="nickName" type="text"
                                   th:value="${memberDTO.nickName}"/>
                            <label for="nickName">닉네임</label>
                            <span class="form-check" id="nickName-span" name="nickName-span" style="display: none"/>
                        </div>

                        <!-- 이름 input-->
                        <div class="form-floating mb-3">
                            <input class="form-control" id="member_name" name="member_name" type="text"
                                   th:value="${memberDTO.member_name}" readonly/>
                            <label for="member_name">이름</label>
                            <span class="form-check" id="name-span" name="name-span" style="display: none"/>
                        </div>

                        <!-- 핸드폰번호 input-->
                        <div class="form-floating mb-3">
                            <input class="form-control" id="phone" name="phone" type="tel"
                                   th:value="${memberDTO.phone}"/>
                            <label for="phone">휴대폰 번호</label>
                            <span class="form-check" id="phone-span" name="phone-span" style="display: none"/>
                        </div>

                        <!-- 생년월일 input-->
                        <div class="form-floating mb-3">
                            <input class="form-control" id="birthday" name="birthday" type="text" th:value="${#temporals.format(memberDTO.addDate, 'yyyy-MM-dd')}" readonly/>
                            <label for="birthday">생년월일</label>
                        </div>

                        <!-- 프로필 이미지 input-->
                        <div class="form-floating mb-3">
                            <div class="uploadHidden">
                                <input class="btn btn-info btn-add" id="profileImg" name="profileImg" value="프로필 사진 추가"/>
                            </div>
                        </div>

                        <!-- 첨부 파일 섬네일을 보여줄 부분 -->
                        <div class="row mt-3">
                            <div class="col">
                                <div class="container-fluid d-flex justify-content-center uploadResult" style="flex-wrap: wrap;">
                                    <div class="card col-4">
                                        <div class="card-body">
                                            <input type="hidden" name="removeImg" th:value="${memberDTO.profileImg}">
                                            <button type="button" class="btn-sm btn-primary" th:onclick="removeFile([[${memberDTO.profileImg}]], this)">X</button>
                                            <img th:src="|/view/s_${memberDTO.profileImg}|" th:data-src="${memberDTO.profileImg}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

<!--                        <div class="d-grid">-->
<!--                            <input class="btn btn-primary btn-submit" name="confirmBtn" value=" 정보수정 " readonly>-->
<!--                            <a href="/mypage/profile" class="btn btn-success" >취소</a>-->
<!--                            <a href="/member/remove" class="btn btn-danger" >회원 탈퇴 신청</a>-->
<!--                        </div>-->

                        <div class="form-group row" style="margin-top: 30px">
                            <div class="col-sm-12 d-flex justify-content-between" >
                                <a href="/member/removeRequest" class="btn btn-danger">회원 탈퇴 신청</a>
                                <div>
                                    <input type="submit" class="btn btn-primary btn-submit" value=" 정보수정 ">
                                    <a href="/mypage/profile" class="btn btn-secondary">취소</a>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
        <!-- 첨부 파일 추가를 위한 모달창 -->
        <div class="modal uploadModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Upload FIle</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="input-group mb-3">
                            <input type="file" name="files" class="form-control" > <!--multiple 을 이용해서 파일 여러개 선택 가능 -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary uploadBtn">Upload</button>
                        <button type="button" class="btn btn-outline-dark closeUploadBtn">Close</button>
                    </div>
                </div>
            </div>
        </div> <!-- register modal -->
    </section>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> <!-- axios 비동기 통신 스크립트 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/member/register.js"></script>
    <script src="/js/member/edit.js"></script>
    <script src="/js/member/upload.js"></script>
</div>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script layout:fragment="script" th:inline="javascript">

    const xhr = new XMLHttpRequest(); // ajax 쓰겠다는 코드
    const confirmCheck = {ePw: false, pw: true, pwRe: true,  nick: true, ph: true};
    const btnSubmit = document.querySelector('.btn-submit');
    const frmAdd = document.querySelector('form[name=registerForm]')
    const passwd = document.querySelector("input[name=password]");
    const passwdRe = document.querySelector("input[name=passwordConfirm]");
    const nickName = document.querySelector("input[name=nickName]");
    const member = document.querySelector("input[name=member_name]");
    const phone = document.querySelector("input[name=phone]");
    const pwCheck = document.querySelector("#pwCheck");
    const pwCk = document.querySelector("div[name=pwCk]");
    const pwCk2 = document.querySelector("div[name=pwCk2]");
    const Epassword = document.querySelector("input[name=Epassword]");
    let isConfirmKey = "false";

    const checkNick = /^[a-zA-Z0-9ㄱ-ㅎㅏ-ㅣ가-힣]+$/;
    const checkSpace = /\s/g;
    const checkPW =  /^(?=.*[a-zA-Z])(?=.*[!@#$%^~*+=-])(?=.*[0-9]).{8,15}$/;

    // 최종 회원가입
    btnSubmit.addEventListener('click', function (e) {

        e.preventDefault();
        e.stopPropagation();

        console.log("confirm_check" + confirm_check())
        if(confirm_check()){

            // 1. 섬네일 영역에서 img 태그의 data-src 속성을 들고옴
            const uploadFiles = uploadResult.querySelectorAll('img');
            let str = '';
            for (let i = 0; i < uploadFiles.length; i++) {
                const uploadFile= uploadFiles[i];
                const imgLink = uploadFile.getAttribute('data-src');

                str += `<input type='hidden' name='profileImg' value="${imgLink}">`;
            }

            // 2. ADD Files 버튼 영역에 태그 추가
            const target = document.querySelector('.uploadHidden'); // ADD File 버튼 영역
            target.innerHTML = str;
            frmAdd.submit();

        } else {
            alert("비어있는 항목이 있습니다.");
            return;
        }
    });

    function confirm_check(){
        console.log(confirmCheck);
        for(const key in confirmCheck) {
            if (confirmCheck[key]) {
                return true;
            }
            else {
                return false;
            }
        }
    }


    // 휴대폰 검사
    phone.addEventListener('focusout', function () {
        const phoneSpan = document.querySelector("span[name=phone-span]")

        confirmCheck.ph = false;

        if (phone.value === "") {
            phoneSpan.innerHTML = "필수 정보 입니다."
            phoneSpan.style.color = "red";
            phoneSpan.style.display = 'block';
        } else {
            phoneSpan.innerHTML = "사용 가능한 번호 입니다."
            phoneSpan.style.color = "green";
            phoneSpan.style.display = 'block';
            confirmCheck.ph = true;
        }
    })

    //닉네임 유효성 검사
    nickName.addEventListener('focusout', function () {
        const nickSpan = document.querySelector("span[name=nickName-span]")

        confirmCheck.nick = false;

        if (nickName.value === "") {
            nickSpan.innerHTML = "필수 정보 입니다."
            nickSpan.style.color = "red";
            nickSpan.style.display = 'block';
        }
        else if(checkSpace.test(nickName.value)){
            nickSpan.innerHTML = "공백을 제거해주세요";
            nickSpan.style.color = "red";
            nickSpan.style.display = 'block';
        }
        else if(!checkNick.test(nickName.value)){
            nickSpan.innerHTML = "특수문자는 사용이 불가능 합니다";
            nickSpan.style.color = "red";
            nickSpan.style.display = 'block';
        }
        else if (nickName.value.length < 2 || nickName.value.length > 10){
            nickSpan.innerHTML = "2 ~ 10자로 입력해주세요"
            nickSpan.style.color = "red";
            nickSpan.style.display = 'block';
        }
        else {
            console.log("-----------------check 화인-------------------")
            xhr.open('GET', '/member_rest/nickCheck/' + nickName.value);
            xhr.send();
            xhr.onreadystatechange = () => {
                if (xhr.readyState !== XMLHttpRequest.DONE)
                    return;

                if (xhr.status === 200) {
                    console.log(xhr.response);
                    const json = JSON.parse(xhr.response);
                    if (json.result === 'true') {
                        nickSpan.innerHTML = "이미 있는 닉네임 입니다";
                        nickSpan.style.color = "red";
                        nickSpan.style.display = 'block';
                    }
                    else {
                        nickSpan.innerHTML = "사용 가능한 닉네임 입니다.";
                        nickSpan.style.color = "green";
                        nickSpan.style.display = 'block';
                        confirmCheck.nick = true;
                    }
                } else {
                    console.error(xhr.status, xhr.statusText);
                }
            }
        }

    });

    // 기존비밀번호 유효성 검사
    Epassword.addEventListener('input', function () {
        confirmCheck.ePw = false;

        console.log("===========Epassword===========")
        const EpassSpan = document.querySelector("span[name=Epass-span]");
        console.log(Epassword.value);
        isConfirmPassword(Epassword.value).then( p => {
            isConfirmKey = p;
            console.log("isConfirmKey========" + isConfirmKey);
            if (isConfirmKey) {
                EpassSpan.innerHTML = "비밀번호가 확인되었습니다.";
                EpassSpan.style.color = "green";
                EpassSpan.style.display = 'block';
                confirmCheck.ePw = true;
            } else {
                EpassSpan.innerHTML = "비밀번호가 일치하지 않습니다.";
                EpassSpan.style.color = "red";
                EpassSpan.style.display = 'block';
            }
        })
    });

    // 변경할 비밀번호 유효성 검사
    pwCheck.addEventListener('click', function () {
        pwCk.style.display = "block";
        pwCk2.style.display = "block";

        confirmCheck.pw = false;

        passwd.addEventListener('focusout', function() {
            const warnPW = document.querySelector("span[name=password-span]")
            // const pwCheckIcon = document.querySelector('#passwordConfirm-span')

            console.log("focusout 실행됨")

            if(passwd.value === ""){
                console.log("공백 확인됨" + passwd)
                warnPW.innerHTML = "필수 정보입니다.";
                warnPW.style.color = "red";
                warnPW.style.display = 'block';
            }
            else if(!checkPW.test(passwd.value) || checkSpace.test(passwd.value)){
                warnPW.innerHTML = "띄어쓰기 없는 8~15자의 영문 대/소문자, 숫자 또는 특수문자 조합으로 입력하셔야 합니다.";
                warnPW.style.color = "red";
                warnPW.style.display = 'block';
            }
            else{
                console.log("비밀번호 사용가능 확인")
                warnPW.innerHTML = "사용 가능한 비밀번호 입니다.";
                warnPW.style.color = "green";
                warnPW.style.display = 'block';
                confirmCheck.pw = true;
            }
        });

        passwdRe.addEventListener('focusout', function () {

            console.log("passwdRe focusout")
            const warnPE = document.querySelector("span[name=passwordRE-span]")

            confirmCheck.pwRe = false;

            if (passwdRe.value !== passwd.value) {
                warnPE.innerHTML = "비밀번호가 일치하지 않습니다.";
                warnPE.style.color = "red";
                warnPE.style.display = 'block';

            } else if (passwdRe.value === "") {
                warnPE.innerHTML = "필수 정보 입니다.";
                warnPE.style.color = "red";
                warnPE.style.display = 'block';

            } else {
                console.log("비밀번호 일치 확인")
                warnPE.innerHTML = "비밀번호가 일치 합니다.";
                warnPE.style.color = "green";
                warnPE.style.display = 'block';
                confirmCheck.pwRe = true;
            }
        });
    });

    // 업로드 모달
    const uploadModal = new bootstrap.Modal(document.querySelector('.uploadModal'));

    document.querySelector('input[name=profileImg]').addEventListener('click', function (e) {
        e.stopPropagation();
        e.preventDefault();
        uploadModal.show();
    });

    // 모달창 업로드 버튼 이벤트 처리
    document.querySelector('.uploadBtn').addEventListener('click', function (e) {
        const formObj = new FormData(); // ajax
        const fileInput = document.querySelector("input[name='files']");
        console.log(fileInput.files);
        const files = fileInput.files;
        for (let i = 0; i < files.length; i++) {
            formObj.append("files", files[i]);
        }
        uploadToServer(formObj).then(result => {
            console.log(result);
            for (const uploadResult of result) {
                showUploadFile(uploadResult);
            }
            uploadModal.hide();
        }).catch(e => {
            uploadModal.hide();
        })
    });
    // 업로드된 이미지의 섬네일을 보여줌
    const uploadResult = document.querySelector('.uploadResult');


    function showUploadFile({uuid, fileName, link}) {
        if (document.querySelector('input[name=removeImg]') !== null) {
            removeFileList.push(document.querySelector('input[name=removeImg]').value);
        }
        console.log("삭제할 파일" + removeFileList);
        uploadResult.innerHTML = "";
        const str = `<div class="card col-4">
          <div class="card-header d-flex justify-content-center">
          <input type="hidden" name="removeImg" value="${uuid+"_"+fileName}">
            <button type="button" class="btn-sm btn-primary" onclick="removeFile('${uuid+"_"+fileName}' , this)">X</button>
          </div>
          <div class="card-body">
                <img src="/view/${link}" data-src="${uuid+"_"+fileName}">
          </div>
        </div>`;
        uploadResult.innerHTML += str;
    }

    // 1. 첨부파일 삭제 처리
    const removeFileList = []; // 최종적으로 삭제될 파일들의 목록

    function removeFile(profileImg, obj) {
        if (!confirm('파일을 삭제하시겠습니까?')) {
            return;
        }
        console.log(profileImg);
        console.log(obj);
        removeFileList.push({profileImg});

        const targetDiv = obj.closest('.card');
        console.log(targetDiv);
        targetDiv.remove();
        // targetDiv.innerHTML = "";
    }



</script>
</body>
</html>